#!/bin/sh -eu

export_and_mkdir() {
	if [ $# -ne 2 ]; then
		abort "export_and_mkdir requires exactly 2 arguments" >&2
	fi

	export "$1"="$2"
	mkdir -p "$2"
}

bootstrap() {
	if ! DOTPATH="$(cd "$(dirname "$0")" && pwd)"; then
		echo "Failed to resolve DOTPATH" >&2
		exit 1
	fi
	export DOTPATH
	echo "${DOTPATH}" >"${HOME}/.dotpath"

	_DOTFILES_SCRIPT_HOME="${DOTPATH}/scripts"
	. "${_DOTFILES_SCRIPT_HOME}/lib/log.sh"

	export_and_mkdir XDG_CONFIG_HOME "${HOME}/.config"
	export_and_mkdir XDG_DATA_HOME "${HOME}/.local/share"

	export DOTFILES_CONFIG_HOME="${DOTPATH}/configs"
	export_and_mkdir DOTFILES_DATA_HOME "${XDG_DATA_HOME}/dotfiles"
	export_and_mkdir DOTFILES_LOCAL_HOME "${XDG_CONFIG_HOME}/dotfiles/local"
	export_and_mkdir DOTFILES_ORIGINAL_HOME "${XDG_CONFIG_HOME}/dotfiles/original"
}

execute_script() {
	if [ $# -eq 0 ]; then
		echo "Usage: $0 [profile] <subcommand> [args...]"
		abort "Subcommand is required."
	fi

	case "$1" in
	local)
		local profile="local"
		shift
		;;
	global)
		local profile="global"
		shift
		;;
	*)
		local profile="global"
		;;
	esac
	log trace "profile: ${profile}"

	if [ $# -eq 0 ]; then
		echo "Usage: $0 [profile] <subcommand> [args...]"
		abort "Subcommand is required."
	fi

	local subcommand="$1"
	log trace "subcommand: ${subcommand}"
	shift

	case "${profile}" in
	global)
		local _DOTFILES_CONFIG_HOME="${DOTFILES_CONFIG_HOME}"
		local _DOTFILES_STASH_ROOT="${DOTFILES_ORIGINAL_HOME}"
		local _DOTFILES_VERSION_LOCK_FILE="${XDG_DATA_HOME}/dotfiles/version.lock"
		local _DOTFILES_MIGRATION_SCRIPTS_DIR="${_DOTFILES_SCRIPT_HOME}/lib/migrations"
		;;
	local)
		if ! [ -r "$HOME/.dotpath.local" ] || ! local_dotpath=$(cat "$HOME/.dotpath.local"); then
			log error "Failed to read local dotpath from ${HOME}/.dotpath.local"
			return 1
		fi
		local _DOTFILES_CONFIG_HOME="${local_dotpath}/configs"
		local _DOTFILES_STASH_ROOT="/dev/null"
		local _DOTFILES_VERSION_LOCK_FILE=""
		local _DOTFILES_MIGRATION_SCRIPTS_DIR=""
		;;
	*)
		abort "Invalid profile: ${profile}"
		;;
	esac

	local subcommand_source="${_DOTFILES_SCRIPT_HOME}/${subcommand}.sh"
	if ! [ -x "${subcommand_source}" ]; then
		abort "Unknown subcommand: ${subcommand}"
	fi

	# shellcheck disable=SC2086
	env _DOTFILES_SCRIPT_HOME="${_DOTFILES_SCRIPT_HOME}" \
		_DOTFILES_STASH_ROOT="${_DOTFILES_STASH_ROOT}" \
		_DOTFILES_VERSION_LOCK_FILE="${_DOTFILES_VERSION_LOCK_FILE}" \
		_DOTFILES_MIGRATION_SCRIPTS_DIR="${_DOTFILES_MIGRATION_SCRIPTS_DIR}" \
		"${subcommand_source}" "$@"
}

main() {
	bootstrap
	execute_script "$@"
}

main "$@"
